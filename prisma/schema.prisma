generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Announcement {
  id             String       @id @default(cuid())
  title          String
  content        String
  priority       Int          @default(0)
  expiresAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([expiresAt])
  @@index([organizationId])
}

model CertificationType {
  id               String              @id @default(cuid())
  name             String
  description      String?
  validityMonths   Int                 @default(12)
  isRequired       Boolean             @default(false)
  requiredForRoles String              @default("[]")
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  organizationId   String
  organization     Organization        @relation(fields: [organizationId], references: [id])
  certifications   UserCertification[]

  @@index([organizationId])
}

model HolidayRequest {
  id        String   @id @default(cuid())
  startDate DateTime
  endDate   DateTime
  hours     Int      @default(8)
  reason    String?
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([startDate, endDate])
  @@index([userId])
}

model Location {
  id                  String          @id @default(cuid())
  name                String
  address             String?
  latitude            Float?
  longitude           Float?
  clockInRadiusMetres Int             @default(100)
  isActive            Boolean         @default(true)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  organizationId      String
  breakRules          String?
  organization        Organization    @relation(fields: [organizationId], references: [id])
  staff               LocationStaff[]
  shifts              Shift[]
  primaryUsers        User[]

  @@index([organizationId])
}

model LocationStaff {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  locationId String
  userId     String
  location   Location @relation(fields: [locationId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([locationId, userId])
  @@index([userId])
}

model Message {
  id         String        @id @default(cuid())
  content    String
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  senderId   String
  receiverId String?
  shiftId    String?
  receiver   User?         @relation("Message_receiverIdToUser", fields: [receiverId], references: [id])
  sender     User          @relation("Message_senderIdToUser", fields: [senderId], references: [id])
  shift      Shift?        @relation(fields: [shiftId], references: [id])
  reads      MessageRead[]

  @@index([createdAt])
  @@index([receiverId])
  @@index([senderId])
  @@index([shiftId])
}

model MessageRead {
  id        String   @id @default(cuid())
  readAt    DateTime @default(now())
  messageId String
  userId    String
  message   Message  @relation(fields: [messageId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([messageId, userId])
  @@index([userId])
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([isRead])
  @@index([userId])
}

model Organization {
  id                   String              @id @default(cuid())
  name                 String
  timezone             String              @default("UTC")
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  breakRules           String              @default("[{\"minHours\":4,\"breakMinutes\":15},{\"minHours\":6,\"breakMinutes\":30},{\"minHours\":8,\"breakMinutes\":60}]")
  clockInWindowMinutes Int                 @default(15)
  clockOutGraceMinutes Int                 @default(30)
  shiftReminderHours   Int                 @default(24)
  locationLatitude     Float?
  locationLongitude    Float?
  clockInRadiusMetres  Int                 @default(100)
  requireGeolocation   Boolean             @default(true)
  announcements        Announcement[]
  certificationTypes   CertificationType[]
  locations            Location[]
  shifts               Shift[]
  shiftCategories      ShiftCategory[]
  shiftTemplates       ShiftTemplate[]
  staffRoles           StaffRole[]
  trainingDocuments    TrainingDocument[]
  users                User[]
}

model Shift {
  id                    String         @id @default(cuid())
  title                 String
  description           String?
  startTime             DateTime
  endTime               DateTime
  status                String         @default("SCHEDULED")
  isOpen                Boolean        @default(false)
  scheduledBreakMinutes Int            @default(0)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  organizationId        String
  assignedToId          String?
  createdById           String
  templateId            String?
  categoryId            String?
  locationId            String?
  messages              Message[]
  assignedTo            User?          @relation("Shift_assignedToIdToUser", fields: [assignedToId], references: [id])
  category              ShiftCategory? @relation(fields: [categoryId], references: [id])
  createdBy             User           @relation("Shift_createdByIdToUser", fields: [createdById], references: [id])
  location              Location?      @relation(fields: [locationId], references: [id])
  organization          Organization   @relation(fields: [organizationId], references: [id])
  template              ShiftTemplate? @relation(fields: [templateId], references: [id])
  swapRequests          SwapRequest[]
  timeEntries           TimeEntry[]

  @@index([assignedToId])
  @@index([categoryId])
  @@index([locationId])
  @@index([organizationId])
  @@index([startTime, endTime])
}

model ShiftCategory {
  id             String             @id @default(cuid())
  name           String
  hourlyRate     Float              // Default rate (can be overridden per user)
  color          String             @default("#3b82f6")
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  organizationId String
  shifts         Shift[]
  organization   Organization       @relation(fields: [organizationId], references: [id])
  templates      ShiftTemplate[]
  userRates      UserCategoryRate[]

  @@index([organizationId])
}

model ShiftTemplate {
  id             String         @id @default(cuid())
  name           String
  description    String?
  defaultTitle   String?
  startTime      String
  endTime        String
  daysOfWeek     String         @default("[]")
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organizationId String
  categoryId     String?
  shifts         Shift[]
  category       ShiftCategory? @relation(fields: [categoryId], references: [id])
  organization   Organization   @relation(fields: [organizationId], references: [id])

  @@index([categoryId])
  @@index([organizationId])
}

model StaffAvailability {
  id           String    @id @default(cuid())
  dayOfWeek    Int
  startTime    String
  endTime      String
  isRecurring  Boolean   @default(true)
  specificDate DateTime?
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userId       String
  user         User      @relation(fields: [userId], references: [id])

  @@index([dayOfWeek])
  @@index([userId])
}

model StaffRole {
  id             String       @id @default(cuid())
  name           String
  code           String
  description    String?
  color          String       @default("#6b7280")
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, code])
  @@index([organizationId])
}

model SwapRequest {
  id         String   @id @default(cuid())
  type       String
  message    String?
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  shiftId    String
  fromUserId String
  toUserId   String?
  fromUser   User     @relation("SwapRequest_fromUserIdToUser", fields: [fromUserId], references: [id])
  shift      Shift    @relation(fields: [shiftId], references: [id])
  toUser     User?    @relation("SwapRequest_toUserIdToUser", fields: [toUserId], references: [id])

  @@index([fromUserId])
  @@index([shiftId])
  @@index([toUserId])
}

model TimeEntry {
  id                String    @id @default(cuid())
  clockIn           DateTime
  clockOut          DateTime?
  breakStart        DateTime?
  breakEnd          DateTime?
  totalBreak        Int       @default(0)
  notes             String?
  status            String    @default("PENDING")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  clockInLatitude   Float?
  clockInLongitude  Float?
  clockOutLatitude  Float?
  clockOutLongitude Float?
  userId            String
  shiftId           String?
  shift             Shift?    @relation(fields: [shiftId], references: [id])
  user              User      @relation(fields: [userId], references: [id])

  @@index([clockIn])
  @@index([shiftId])
  @@index([userId])
}

model TrainingDocument {
  id               String            @id @default(cuid())
  title            String
  description      String?
  fileUrl          String
  fileName         String
  validityMonths   Int               @default(12)
  isRequired       Boolean           @default(false)
  requiredForRoles String            @default("[]")
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  organizationId   String
  organization     Organization      @relation(fields: [organizationId], references: [id])
  signoffs         TrainingSignoff[]

  @@index([organizationId])
}

model TrainingSignoff {
  id         String           @id @default(cuid())
  signedAt   DateTime         @default(now())
  expiresAt  DateTime
  signature  String?
  userId     String
  documentId String
  document   TrainingDocument @relation(fields: [documentId], references: [id])
  user       User             @relation(fields: [userId], references: [id])

  @@unique([userId, documentId])
  @@index([expiresAt])
  @@index([userId])
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  name              String
  password          String
  role              String              @default("EMPLOYEE")
  staffRole         String              @default("DESK")
  avatarUrl         String?
  phone             String?
  holidayBalance    Int                 @default(200)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  organizationId    String
  primaryLocationId String?
  holidayRequests   HolidayRequest[]
  locationAccess    LocationStaff[]
  messagesReceived  Message[]           @relation("Message_receiverIdToUser")
  messagesSent      Message[]           @relation("Message_senderIdToUser")
  messageReads      MessageRead[]
  notifications     Notification[]
  assignedShifts    Shift[]             @relation("Shift_assignedToIdToUser")
  createdShifts     Shift[]             @relation("Shift_createdByIdToUser")
  availability      StaffAvailability[]
  swapRequestsFrom  SwapRequest[]       @relation("SwapRequest_fromUserIdToUser")
  swapRequestsTo    SwapRequest[]       @relation("SwapRequest_toUserIdToUser")
  timeEntries       TimeEntry[]
  trainingSignoffs  TrainingSignoff[]
  organization      Organization        @relation(fields: [organizationId], references: [id])
  primaryLocation   Location?           @relation(fields: [primaryLocationId], references: [id])
  certifications    UserCertification[]
  categoryRates     UserCategoryRate[]

  @@index([email])
  @@index([organizationId])
  @@index([staffRole])
}

model UserCertification {
  id                     String            @id @default(cuid())
  issueDate              DateTime
  expiryDate             DateTime?
  certificateNumber      String?
  notes                  String?
  status                 String            @default("ACTIVE")
  lastExpiryNotification DateTime?
  staffSignature         String?           // Staff counter-signature
  staffSignedAt          DateTime?         // When staff signed
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  userId                 String
  certificationTypeId    String
  certificationType      CertificationType @relation(fields: [certificationTypeId], references: [id])
  user                   User              @relation(fields: [userId], references: [id])

  @@index([certificationTypeId])
  @@index([expiryDate])
  @@index([userId])
}

model UserCategoryRate {
  id         String        @id @default(cuid())
  hourlyRate Float
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  userId     String
  categoryId String
  category   ShiftCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@index([categoryId])
}
